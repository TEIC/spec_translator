<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spec Translator: User</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script src="js/translator.js" charset="utf-8"></script>
    <style>
      ol>li {
        margin-top: 1em;;
      }
    </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #2277bb;">
    <div class="container-fluid justify-content-start">
      <a href="https://tei-c.org" class="navbar-brand">
        <img src="css/TEI-logo.png" alt="TEI" height="50">
      </a>
      <ul class="navbar-nav d-flex justify-content-end">
        <li class="nav-item">
          <a class="nav-link" href="/">Browse</a>
        </li>
      </ul>
    </div>
    
  </nav>
  <ol>
    <li class="container">
      <p>Choose or create a repository to save to:</p>
      <form onsubmit="return false" class="row g-3">
        <div class="col-auto">
          <input class="form-control" name="owner" type="text" id="owner">
          <div class="form-text" id="ownertext"></div>
        </div>
        <div class="col-auto" style="font-size: 2em; line-height: 30px;"> / <span id="TEIRepository" style="color: darkgray;">no repository</span></div>
        <div class="col-auto"><button type="submit" class="btn btn-primary" id="createFork" disabled>Create a Fork</button></div>
      </form>
    </li>
    <li class="container">
      <p>Choose or create a branch to save to:</p>
      <form onsubmit="return false" class="row g-3">
        <div class="col-auto" style="font-size: 2em; line-height: 30px;;">
          <span id="owner2">owner</span> / <span id="TEIRepository2">repository</span> /
        </div>
        <div class="col-auto">
          <input class="form-control" name="branch" list="branches" id="branch" placeholder="branch..." disabled autocomplete="off">
          <div class="form-text" id="branchtext"></div>
          <datalist id="branches">
          </datalist>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary" id="createBranch" disabled>Create a Branch</button>
        </div>
      </form>
      <div></div>
    </li>
    <li class="container"><a href="/">Choose a TEI page to translate</a> <span id="rememberedpage"></span></li>
  </ol>
  
  <script>
    let t = new Translator({noCETEI: true});
    if (!t.loggedIn()) {
      window.location = '/auth/login';
    }
    function checkRepo(owner, repo) {
      t.getCollaborators(owner, repo).then(data => {
          if (data.message) {
            document.getElementById("TEIRepository").innerHTML = 'no repository';
            document.getElementById('createFork').removeAttribute('disabled');
          } else {
            if (data.filter(c => c.login == window.sessionStorage.getItem("user") && c.permissions.push === true).length == 0) {
              with (document.getElementById("TEIRepository")) {
                innerHTML = "You can't save to this repo.";
                setAttribute('style', 'color: red');
              }
            } else {
              document.getElementById("TEIRepository").removeAttribute('style');
              setupBranches(owner, repo);
            }
          }
        });
    }
    function setupBranches(owner, repo) {
      document.getElementById("branch").value = '';
      document.getElementById("branches").innerHTML = '';
      t.getUniqueRepoBranches(owner, repo).then(data => {
          document.getElementById("branches").innerHTML = '';
          data.forEach(branch => {
            let opt = document.createElement('option');
            opt.setAttribute('value', branch.name);
            opt.innerHTML = branch.name;
            document.getElementById("branches").appendChild(opt);
            if (window.sessionStorage.getItem('branch') == branch.name) {
              document.getElementById('branch').value = branch.name;
            }
          });
          document.getElementById('branch').removeAttribute('disabled');
        });
    }
    function setupRepo() {
      t.getTEIRepo(owner).then(repository => {
        if (repository) {
          repo = repository.name;
          window.sessionStorage.setItem('repo', repo);
          with (document.getElementById("TEIRepository")) {
            innerHTML = repo;
            removeAttribute('style');
          }
          with (document.getElementById("TEIRepository2")) {
            innerHTML = repo;
            removeAttribute('style');
          }
          document.getElementById('createFork').setAttribute('disabled', '');
          t.mergeUpstream(owner, repo); // Need some message if this fails
          setupBranches(owner, repo);
        } else {
          with (document.getElementById("TEIRepository")) {
            innerHTML = 'no repository';
            setAttribute('style', 'color: darkgray');
          }
          with (document.getElementById("TEIRepository2")) {
            innerHTML = 'no repository';
            setAttribute('style', 'color: darkgray');
          }
          document.getElementById('createFork').removeAttribute('disabled');
          document.getElementById('branch').setAttribute('disabled', '');
        }
    });
    }
    // Set up owner info
    let owner = window.sessionStorage.getItem('owner');
    if (!owner) {
      owner = window.sessionStorage.getItem('user');
      window.sessionStorage.setItem('owner', owner);
      window.sessionStorage.setItem('ownerType', 'user');

    }
    let repo = window.sessionStorage.getItem('repo');
    document.getElementById('owner').value = owner;
    document.getElementById('owner2').innerHTML = owner;
    document.getElementById('owner').addEventListener('change', ev => {
      if (ev.target.value == '') {
        ev.target.value = owner;
        return;
      }
      t.checkOwner(ev.target.value).then(result => {
        if (result) {
          owner = ev.target.value;
          window.sessionStorage.setItem('owner', owner);
          window.sessionStorage.setItem('ownerType', result);
          document.getElementById("owner2").innerHTML = owner;
          document.getElementById('ownertext').innerHTML = '';
          setupRepo();
          if (repo) {
            if (window.sessionStorage.getItem('ownerType') == 'organization') {
              checkRepo(owner, repo);
            } else {
              setupBranches(owner, repo);
            }
          }
        } else {
          document.getElementById('ownertext').innerHTML = 'You are not a member of this organization.','';
          document.getElementById('createFork').setAttribute('disabled','');
          document.getElementById('owner2').innerHTML = '...';
          with (document.getElementById("TEIRepository")) {
            innerHTML = 'no repository';
            setAttribute('style', 'color: darkgray');
          }
          with (document.getElementById("TEIRepository2")) {
            innerHTML = 'no repository';
            setAttribute('style', 'color: darkgray');
          }
        }
        
      });
    });
    // Set up repo info
    setupRepo();
    document.getElementById("createFork").addEventListener('click', ev => {
      ev.target.innerHTML = 'Creating Fork...'
      ev.target.setAttribute('disabled','');
      t.forkTEIRepo(window.sessionStorage.getItem('ownerType') == 'organization' ? owner : null)
        .then(fork => {
          if (fork.message) {
            console.log('Fork failed');
            console.log(fork.message);
          } else {
            repo = fork.name;
            window.sessionStorage.setItem('repo', fork.name);
            ev.target.innerHTML = 'Create Fork';
            with (document.getElementById("TEIRepository")) {
              innerHTML = repo;
              removeAttribute('style');
            }
            with (document.getElementById("TEIRepository2")) {
              innerHTML = repo;
              removeAttribute('style');
            }
            document.getElementById('createFork').setAttribute('disabled', '');
            setupBranches(owner, repo);
          }
        });
    });
    // Set up branches
    document.getElementById("branch").addEventListener('change', ev => {
      if (ev.target.value != '') {
        t.getBranch(owner, repo, ev.target.value).then(data => {
          if (data.message) {
            document.getElementById('createBranch').removeAttribute('disabled');
            document.getElementById('branchtext').innerHTML = "Branch does not exist. Click 'Create a Branch'";
          } else {
            window.sessionStorage.setItem('branch', data.name);
            window.sessionStorage.setItem('head', data.commit.sha);
            document.getElementById('createBranch').setAttribute('disabled','');
          }
        });
      } else {
        document.getElementById('createBranch').setAttribute('disabled','');
      }
    });
    document.getElementById('createBranch').addEventListener('click', ev => {
      let branch = document.getElementById("branch").value;
      if (branch) {
        ev.target.setAttribute('disabled','');
        ev.target.innerHTML = 'Creating branch...';
        document.getElementById('branchtext').innerHTML = '';
        t.getBranch(owner, repo, 'dev').then(data => {
            t.createRef(branch, data.commit.sha).then(ref => {
              if (ref.message) {
                document.getElementById('branchtext').innerHTML = `Could not create branch ${branch}`; 
              } else {
                window.sessionStorage.setItem('head', ref.object.sha);
                let opt = document.createElement('option');
                opt.setAttribute('value', window.sessionStorage.getItem('branch'));
                opt.innerHTML = window.sessionStorage.getItem('branch');
                document.getElementById('branches').appendChild(opt);
                ev.target.innerHTML = 'Create a Branch';
              }
            });
        });
      }
      return false;
    });
  </script>
</body>
</html>